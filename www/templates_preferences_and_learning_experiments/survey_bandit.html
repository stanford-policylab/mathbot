<!doctype html>
<html lang="en">

<head>
    <title>Mathbot Survey - Bandit</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
</head>

<body>
<h1 style="text-align: center" id="surveyTitle">
    Online Learning Experience Study
</h1>
<br>
<div class="container">

    <!-- Progress bar -->
    <div class="row">
        <div class="col-12">
            <div class="progress">
                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                     role="progressbar"
                     aria-valuenow="75"
                     aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- Beginning of survey -->
    <div class="row">
        <form id="exp-form" class="col-12" action="/api/exp_form" method="post">

            <!-- Page 1 -->
            <!-- Consent page -->
            <div class="form-page">
                <div class="card card-body">
                    <strong>Consent Form</strong>
                    <div class="panel-body" id="consent">
                        <ul>
                            <li>
                                <strong>Description:</strong>
                                <br> You are invited to participate in a research study on learning math. First, you
                                will complete a short eligibility quiz. If you pass the 1<sup>st</sup> eligibility quiz,
                                you will complete a brief survey and an additional eligibility quiz. If eligible for the
                                full study, you
                                will complete a learning module and an additional quiz.
                            </li>
                            <li>
                                <strong>Time Involvement:</strong>
                                <br> The 1<sup>st</sup> eligibility quiz should take less than 2 minutes. The brief
                                survey and 2<sup>nd</sup> eligibility quiz should take less than 8 minutes. If you are
                                eligible for the full study, your participation should take an additional 10 minutes.
                            </li>
                            <li>
                                <strong>Risks and Benefits:</strong>
                                <br> The risks associated with this study are minimal and negligible. The benefits which
                                may
                                reasonably
                                be expected to result from this study are improved mathematical understanding. More
                                broadly,
                                the
                                study will help to improve math education. We cannot and do not guarantee or promise
                                that
                                you
                                will
                                receive
                                any benefits from this study.
                            </li>
                            <li>
                                <strong>Payment:</strong>
                                <br> You will receive <b>$0.10</b> for completing the 1<sup>st</sup> eligibility quiz.
                                If you pass the 1<sup>st</sup> eligiblity quiz, you will receive an additional
                                <b>$0.25</b> for completing a brief survey and the 2<sup>nd</sup> eligiblity quiz. If
                                eligible for the full study, a bonus payment of up to <b>$2</b> will be awarded
                                proportionally to your quiz performance.
                            </li>
                            <li>
                                <strong>Subject's Rights:</strong>
                                <br> If you have read this form and have decided to participate in this project, please
                                understand
                                your
                                participation is voluntary and you have the right to withdraw your consent or
                                discontinue
                                participation
                                at any time without penalty or loss of benefits to which you are otherwise entitled. The
                                alternative
                                is not to participate. You have the right to refuse to answer particular questions. Your
                                individual
                                privacy will be maintained in all published and written data resulting from the study.
                            </li>
                            <li>
                                <strong>Contact Information:</strong>
                                <br> Questions: If you have any questions, concerns, or complaints about this research,
                                its
                                procedures,
                                its risks, or its benefits, contact the Protocol Director, Sharad Goel (607-339-9903)
                                <br> Independent Contact: If you are not satisfied with how this study is being
                                conducted,
                                or if you
                                have any concerns, complaints, or general questions about the research or your rights as
                                a
                                participant,
                                please contact the Stanford Institutional Review Board (IRB) to speak to someone
                                independent
                                of the
                                research team at (650)-723-2480 or toll free at 1-866-680-2906. You can also write to
                                the
                                Stanford
                                IRB, Stanford University, 3000 El Camino Real, Five Palo Alto Square, 4th Floor, Palo
                                Alto,
                                CA
                                94306.
                                <br> Please print a copy of this page for your records.
                            </li>

                        </ul>
                        <b>Do not redo this HIT if you have already completed it. You will not be paid for
                            additional attempts.</b><br>
                        <br>
                        <b>Do not complete this
                            HIT on a
                            mobile device or tablet.</b><br>
                        <br>
                        <b>Do not close this window until you are finished with the experiment. You cannot return to the
                            experiment after you close this window.</b><br>
                        <br>
                        By clicking "Next", you indicate that you have carefully read the consent form
                        and agree to participate in this study.
                    </div>
                </div>
            </div>

            <!-- Page 2 -->
            <div class="form-page">
                <!-- Prerequisite Quiz -->
                <div class="form-page-head">
                    <strong>1<sup>st</sup> Eligibility Quiz </strong><br>
                    Please answer the following 5 questions.
                    <ul>
                        <li>You are encouraged to use scratch paper.</li>
                        <li>You are welcome to use a calculator.</li>
                        <li>This is an academic study. Please do not consult any outside resources while completing the
                            quiz.
                        </li>
                    </ul>
                </div>
                <br>

                <!-- Prerequisite-quiz -->
                {% with questionList=quiz_config.prerequisiteQuiz, session=0 %}
                {% include 'quiz.html' %}
                {% endwith %}

            </div>

            <!-- Page 3 -->
            <!-- Instruction page -->
            <div class="form-page">
                <div class="card card-body">
                    <div class="panel-body" id="instructionBody">
                        <strong>You passed the 1<sup>st</sup> eligibility quiz!</strong><br>
                        <br>
                        You will now complete a brief survey and another short quiz.<br>
                        <br>
                        If you do not wish to answer a question in the survey, select “Prefer not to disclose” or enter
                        “N/A”.
                    </div>
                </div>
            </div>

            <!-- Page 4 -->
            <div class="form-page">
                <!-- Question 1 -->
                <div class="form-group radio">
                    <label class="question">What is your gender?</label>
                    <div class="form-check">
                        <label class="form-check-label">
                            <input class="form-check-input" type="radio" name="gender" value="f"> Female
                        </label>
                    </div>
                    <div class="form-check">
                        <label class="form-check-label">
                            <input class="form-check-input" type="radio" name="gender" value="m"> Male
                        </label>
                    </div>
                    <div class="form-check">
                        <label class="form-check-label">
                            <input class="form-check-input" type="radio" name="gender" value="o"> Other
                        </label>
                    </div>
                    <div class="form-check">
                        <label class="form-check-label">
                            <input class="form-check-input" type="radio" name="gender" value=""> Prefer not to
                            disclose
                        </label>
                    </div>
                </div>

                <!-- Question 2 -->
                <div class="form-group text">
                    <label for="age">What is your age?</label>
                    <input type="text" class="form-control" name="age" id="age"
                           placeholder="">
                </div>

                <!-- Question 3-->
                <div class="form-group select">
                    <label class='question' for="Degree">
                        What is your highest level of education?
                    </label>
                    <select class="form-control" id="degree" name="degree">
                        <option selected="selected" value="">- select one -</option>
                        <option>Less than middle school</option>
                        <option>Middle school</option>
                        <option>High school</option>
                        <option>Associate's degree</option>
                        <option>Bachelor's degree</option>
                        <option>Master's degree</option>
                        <option>Doctoral degree</option>
                        <option>Prefer not to disclose</option>
                    </select>
                </div>
                <br>

                <div class="form-page-head">
                    <strong>Previous experience with technology: </strong> <br>
                </div>
                <br>
                <div class="form-group radio">
                    <label>Compared to the average person, how often do you think you use the Internet?
                    </label>
                    <div class="likert row">
                        <ul class='likert'>
                            <li>
                                <input type="radio" name="time-on-internet" value="1">
                                <label>A lot less</label>
                            </li>
                            <li>
                                <input type="radio" name="time-on-internet" value="2">
                                <label>Less</label>
                            </li>
                            <li>
                                <input type="radio" name="time-on-internet" value="3">
                                <label>About the same</label>
                            </li>
                            <li>
                                <input type="radio" name="time-on-internet" value="4">
                                <label>More</label>
                            </li>
                            <li>
                                <input type="radio" name="time-on-internet" value="5">
                                <label>A lot more</label>
                            </li>
                            <li>
                                <input type="radio" name="time-on-internet" value="">
                                <label>Prefer not to disclose</label>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="form-group radio">
                    <label>Compared to the average person, how often do you think you use text/chat interfaces (text
                        messaging on a cell phone, iMessage, Facebook
                        Messenger, WhatsApp, etc.)?
                    </label>
                    <div class="likert row">
                        <ul class='likert'>
                            <li>
                                <input type="radio" name="texting-proficiency" value="1">
                                <label>A lot less</label>
                            </li>
                            <li>
                                <input type="radio" name="texting-proficiency" value="2">
                                <label>Less</label>
                            </li>
                            <li>
                                <input type="radio" name="texting-proficiency" value="3">
                                <label>About the same</label>
                            </li>
                            <li>
                                <input type="radio" name="texting-proficiency" value="4">
                                <label>More</label>
                            </li>
                            <li>
                                <input type="radio" name="texting-proficiency" value="5">
                                <label>A lot more</label>
                            </li>
                            <li>
                                <input type="radio" name="texting-proficiency" value="">
                                <label>Prefer not to disclose</label>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Page 5 -->
            <div class="form-page">
                <!-- Question 5-->
                <div class="form-page-head">
                    <strong>Previous experience with online courses: </strong> <br>
                </div>

                <!-- Question 5-1 -->
                <div class="form-group select">
                    <label for="mooc-no">How many online courses (Khan Academy, Coursera, Udacity, etc.) have you
                        started?
                    </label>
                    <select class="form-control" id="mooc-no" name="mooc-no">
                        <option selected="selected" value="">- select one -</option>
                        <option>I have never started an online course</option>
                        <option>1 course</option>
                        <option>2 courses</option>
                        <option>3 - 5 courses</option>
                        <option>More than 5 courses</option>
                        <option>Prefer not to disclose</option>
                    </select>
                </div>
                <br>

                <!-- Question 5-2 -->
                <div class="form-group text">
                    <label for="mooc-comments">What is your opinion of online courses? For example:
                    </label>
                    <ul>
                        <li>Do you like the way they teach?</li>
                        <li>How engaged and focused are you while working on online courses?</li>
                        <li>Have the courses you've taken adapted to your learning habits and performance?</li>
                    </ul>
                    <textarea class="form-control" cols="250" id="mooc-comments" name="mooc-comments" required=""
                              rows="1"
                              placeholder=""></textarea>
                </div>
                <br>

                <!-- Question 6-->
                <div class="form-page-head">
                    <strong>Previous experience with arithmetic sequences: </strong>
                </div>
                <div class="form-group select">
                    <label for="math-background">How familiar are you with arithmetic sequences?
                    </label>
                    <select class="form-control" id="math-background" name="math-background">
                        <option selected="selected" value="">- select one -</option>
                        <option value="advanced">I clearly understand arithmetic sequences.</option>
                        <option value="basic">I have worked with arithmetic sequences in the past.</option>
                        <option value="none">I have not heard of arithmetic sequences.</option>
                        <option>Prefer not to disclose</option>
                    </select>
                </div>
            </div>

            <!-- Page 6 -->
            <!-- Scratch paper confirmation -->
            <div class="form-page">
                <div class="card card-body">
                    <strong>2<sup>nd</sup> Eligibility Quiz</strong>
                    <div class="panel-body">
                        <br>
                        This quiz determines your eligibility for the rest of the study and a bonus payment of up to $2.<br>
                        <br>
                        To pass the quiz, you <u>do not</u> need to get every question correct. Just try your best!
                        <ul>
                            <li>If you don't know the answer to a question, enter "I don't know" or "idk".</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Page 7 -->
            <!-- Pre-experiment Quiz -->
            <div class="form-page">
                <div class="form-page-head">
                    <strong>2<sup>nd</sup> Eligibility Quiz</strong><br>
                    Please answer the following 11 questions to the best of your ability.
                    <ul>
                        <li>You are encouraged to use scratch paper.</li>
                        <li>If you don't know the answer to a question, enter "I don't know" or "idk".</li>
                        <li>This is an academic study. Please do not consult any outside resources while completing the
                            quiz.
                        </li>
                    </ul>
                </div>
                <br>

                <!-- Pre-quiz -->
                {% with questionList=quiz_config.preQuiz, session=1 %}
                {% include 'quiz.html' %}
                {% endwith %}

            </div>


            <!-- Page 8 -->
            <div id="expPage" class="form-page">
                <!-- Experiments -->
                {% include 'experiment_bandit.html' %}

            </div>

            <!-- Page 9 -->
            <!-- post-experiment Quiz -->
            <div class="form-page">
                <div class="form-page-head">
                    <strong>Post-Learning Quiz</strong>
                    <br>
                    Your bonus payment of up to $2 is proportional to your score on this 3-question quiz.
                    <ul>
                        <li>You are encouraged to use scratch paper.</li>
                        <li>This is an academic study. Please do not consult any outside resources while completing the
                            quiz.
                        </li>
                    </ul>
                    <br>
                </div>

                <!-- Post-quiz -->
                {% with questionList=quiz_config.postQuiz, session=2 %}
                {% include 'quiz.html' %}
                {% endwith %}

            </div>
        </form>
    </div>
</div>

<div class="container">
    <!-- NavBar -->
    <div id="navbar" class="raw align-items-end" style="margin-top: 20px">
        <div class="col">
            <nav aria-label="Page navigation">
                <ul class="pagination pagination-lg justify-content-center">
                    <li class="page-item" id="prev"><a class="page-link" onclick="previousPage()">Previous</a>
                    </li>
                    <!-- <li class="page-item" id="submit"><a class="page-link" onclick="mySubmit()">Submit</a>
                    </li> -->
                    <li class="page-item" id="next">
                        <a class="page-link" onclick="nextWithConfirmation()">
                            Next
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- confirmation -->
<div class="modal" id="confirmation" tabindex="-1" role="dialog" aria-labelledby="confirmationModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmationModalLabel">Confirmation</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                You will not be able to go back to this page once you proceed. Do you want to continue?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="nextPage()" data-dismiss="modal">Continue
                </button>
            </div>
        </div>
    </div>
</div>

<form id="completion-form">
    <input type="hidden" name="assignmentId" value="{{ user.assignment_id }}"/>
    <input type="hidden" name="foo" value="bar"/>
</form>

<!-- Bootstrap CSS -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css"
      integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
<link rel="stylesheet" href="../static/resources/css/likert.css">

<!-- Optional JavaScript -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js"
        integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh"
        crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"
        integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ"
        crossorigin="anonymous"></script>

<style type="text/css">
    .card {
        margin: 0 auto;
        float: none;
        margin-bottom: 10px;
    }

    #expFrame {
        border: 1px solid gray;
    }

    .card-header {
        /* background-color: inherit; */
    }

    .form-page {
        display: none;
    }

    .center {
        text-align: center;
    }

    #collapseTrigger {
        color: #fff;
    }

    #submitButton {
        white-space: normal;
    }

    .panel-body tr td {
        width: 14%;
        text-align: center;
        padding: 4px 15px;
    }

    .image {
        margin-bottom: 15px;
    }

    #navbar {
        margin-top: 75px;
    }

    textarea.form-control {
        height: 200px;
        /* Fix for textarea overlapping submit button */
    }
</style>

<script>


    /***
     * Helper functions
     */

    function findGetParameter (parameterName) {
        var result = null,
            tmp = [];
        location.search.substr(1).split('&').forEach(function (item) {
            tmp = item.split('=');
            if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1])
        });
        return result
    }

    /* init */
    var DEBUG = 0;
    var current_base_url = window.location.protocol + '//' + window.location.hostname + ':' + window.location.port;
    var currentPage;
    var userId = '{{ user.session_id }}';
    var userGroup = 'Mathbot';
    var assignmentId = '{{ user.assignment_id }}';
    // by default submit the the sandbox
    var turkSubmitTo = (findGetParameter('turkSubmitTo') + '/mturk/externalSubmit');
    $('#completion-form').attr('action', turkSubmitTo);
    var currentQuizPage = 0;
    var startPageTime = new Date();
    var submitButtonClicked = false;
    //intentionally left global
    partial_form_content = {};

    var quizResponse = [[], [], []];
    var quizTimeStamp = [[], [], []];

    const MAXPAGE = $('.form-page').length;
    const CHECKPOINTS = [1, 2, 3, 7, 8, 9, 10];
    const EXPPAGE = 8;
   //@formatter:off
    const QUIZLENGTH = [{{quiz_config.prerequisiteQuiz | length}},{{quiz_config.preQuiz | length}},{{quiz_config.postQuiz | length}}];
    const QUIZPAGE = [2, 7, 9];
    //@formatter:on

    /* Helper functions */
    function getPartialForm () {
        //var selectedCurrPage = $('.form-page:nth-child(' + currentPage + ')');
        var selectedCurrPage = $('#exp-form');

        /* drop down list, text area, and regular response */
        selectedCurrPage.find('select, textarea, input[type="number"], input[type="text"]').each(function () {
            partial_form_content[$(this).attr('name')] = $(this).val()
        });

        /* radio button or checkbox*/
        selectedCurrPage.find('input[type="radio"], input[type="checkbox"]').each(function () {
            if (this.checked) {
                partial_form_content[$(this).attr('name')] = $(this).val()
            } else {
                /* if nothing has been entered, collected the full form*/
                if (!partial_form_content[$(this).attr('name')]) {
                    partial_form_content[$(this).attr('name')] = ''
                }
            }
        });

        partial_form_content['prereq-quiz-response'] = JSON.stringify(quizResponse[0]);
        partial_form_content['prereq-quiz-time-stamp'] = JSON.stringify(quizTimeStamp[0]);
        partial_form_content['pre-quiz-response'] = JSON.stringify(quizResponse[1]);
        partial_form_content['pre-quiz-time-stamp'] = JSON.stringify(quizTimeStamp[1]);
        partial_form_content['post-quiz-response'] = JSON.stringify(quizResponse[2]);
        partial_form_content['post-quiz-time-stamp'] = JSON.stringify(quizTimeStamp[2])
        // partial_form_content['khan-read-ids'] = JSON.stringify(readIds)
        // partial_form_content['khan-widsatched-ids'] = JSON.stringify(watchedIds)
        // partial_form_content['khan-read-timestamps'] = JSON.stringify(readTimestamps)
        // partial_form_content['khan-watched-timestamps'] = JSON.stringify(watchedTimestamps)
    }

    function getBrowser () {
        // Opera 8.0+
        var isOpera = (!!window.opr && !!opr.addons) || !!window.opera || navigator.userAgent.indexOf(' OPR/') >= 0;
        if (isOpera) {
            return 'Opera'
        }

        // Firefox 1.0+
        var isFirefox = typeof InstallTrigger !== 'undefined';
        if (isFirefox) {
            return 'Firefox'
        }

        // Safari 3.0+ "[object HTMLElementConstructor]"
        var isSafari = /constructor/i.test(window.HTMLElement) ||
            (function (p) { return p.toString() === '[object SafariRemoteNotification]' })(!window['safari'] ||
                (typeof safari !== 'undefined' && safari.pushNotification));
        if (isSafari) {
            return 'Safari'
        }

        // Internet Explorer 6-11
        var isIE = /*@cc_on!@*/false || !!document.documentMode;
        if (isIE) {
            return 'IE'
        }

        // Edge 20+
        var isEdge = !isIE && !!window.StyleMedia;
        if (isEdge) {
            return 'Edge'
        }

        // Chrome 1+
        var isChrome = !!window.chrome && !!window.chrome.webstore;
        if (isChrome) {
            return 'Chrome'
        }
    }

    function logPartialForm (churnOnPage, ifSendToServer, callback) {
        getPartialForm();

        /* user info */
        partial_form_content['user-id'] = userId;
        partial_form_content['assignment-id'] = assignmentId;
        partial_form_content['user-group'] = userGroup;
        partial_form_content['browser'] = getBrowser();
        partial_form_content['user-agent'] = window.navigator.userAgent;
        partial_form_content['platform'] = window.navigator.platform;
        partial_form_content['timestamp-leaving-page-' + currentPage] = (new Date()) * 1;
        // partial_form_content["seconds-on-page-" + currentPage] = (new Date() - startPageTime) / 1000.;
        for (var i = 0; i <= MAXPAGE; i++) {
            if (!partial_form_content['timestamp-leaving-page-' + i]) {
                partial_form_content['timestamp-leaving-page-' + i] = ''
            }
        }

        if (churnOnPage) {
            partial_form_content['churn-on-page'] = churnOnPage
        } else {
            partial_form_content['churn-on-page'] = ''
        }
        startPageTime = new Date();

        if (ifSendToServer) {
            // if churn on consent page, do not submit
            if (partial_form_content['churn-on-page'] != 1) {
                $.ajax({
                    type: 'POST',
                    async: false,
                    url: 'api/log_progress',
                    //url: "api/dump_form",
                    data: partial_form_content,
                    complete: function (data) {
                        callback()
                    },
                    dataType: 'json',
                })
            }
        }
    }

    function moveToPage (page) {
        logPartialForm(false, false);
        page = (page < 1) ? 1 : page;
        page = (page > MAXPAGE) ? MAXPAGE : page;

        $('#next').show();
        $('#prev').show();

        /* show submit at the very end */
        if (page === MAXPAGE) {
            $('#submit').show();
            $('#next').addClass('disabled')
            //$("#next").css('tabindex', "-1");
        } else {
            $('#submit').hide();
            $('#next').removeClass('disabled')
        }

        if (page > 1) {
            $('#surveyTitle').hide()
        }

        /* load the quiz */
        if (QUIZPAGE.indexOf(page) > -1) {
            nextQuiz(0, QUIZPAGE.indexOf(page))
        }

        /* user cannot go back after CHECKPOINTS */
        if (CHECKPOINTS.indexOf(page) >= 0) {
            $('#prev').addClass('disabled')
        } else {
            $('#prev').removeClass('disabled')
        }

        $('.form-page:nth-child(' + currentPage + ')').hide();
        currentPage = page;
        $('.form-page:nth-child(' + currentPage + ')').show();
        $('.progress-bar').css('width', currentPage / MAXPAGE * 100 + '%');

        /* load experiments */
        if (page === EXPPAGE) {
            $('#next').hide();
            $('#prev').hide();
            $.ajax({
                type: 'GET',
                async: false,
                url: 'api/assign_group',
                success: function (response) {
                    userGroup = response;
                    loadInstruction("MathBot")
                },
            })
        }

        if (page === (EXPPAGE + 1)) {
            loadExperiment('')
        }

        console.log('Move to page:' + currentPage)
    }

    function validateRadioCheck (selector) {
        var radioCheckList = selector.find('input');
        var radioCheckListLength = radioCheckList.length;
        var formValid = false;
        var i = 0;
        while (!formValid && i < radioCheckListLength) {
            if (radioCheckList[i].checked) {
                formValid = true
            }
            i++
        }
        return formValid
    }

    function validateSelect (selector) {
        if (selector.children('select').val() === '') {
            return false
        }
        return true
    }

    function validateTextArea (selector) {
        var input = selector.children('input');
        var textArea = selector.children('textArea');

        if (input.length && input.val() === '') {
            return false
        }
        if (textArea.length && textArea.val() === '') {
            return false
        }
        return true
    }

    function validatePage (page) {
        if (DEBUG) {
            return true
        }
        switch (page) {
            case 3:
            case 4:
            case 8:
            case 9:
            case 10:
                var currentFormPage = $('.form-page').eq(page - 1);
                var radioQuestions = currentFormPage.children('.form-group.radio');
                var textQuestions = currentFormPage.children('.form-group.text');
                var selectQuestions = currentFormPage.children('.form-group.select');
                var pageValid = true;
                var i = 0;
                while (pageValid && i < radioQuestions.length) {
                    pageValid = validateRadioCheck(radioQuestions.eq(i));
                    if (!pageValid) {
                        console.log('Radio Question ' + i.toString() + ' is not valid.')
                    }
                    i++
                }
                i = 0;
                while (pageValid && i < textQuestions.length) {
                    pageValid = validateTextArea(textQuestions.eq(i));
                    if (!pageValid) {
                        console.log('Text Question ' + i.toString() + ' is not valid.')
                    }
                    i++
                }
                i = 0;
                while (pageValid && i < selectQuestions.length) {
                    pageValid = validateSelect(selectQuestions.eq(i));
                    if (!pageValid) {
                        console.log('Select Question ' + i.toString() + ' is not valid.')
                    }
                    i++
                }
                if (!pageValid) {
                    console.log('Current page is not validated; cannot move to the next page!')
                }
                return pageValid;
            default:
                return true
        }
    }

    function nextWithConfirmation () {
        if (CHECKPOINTS.indexOf(currentPage + 1) >= 0) {
            $('#confirmation').modal('show');
            console.log('show confirmation')
        } else {
            nextPage()
        }

    }

    function nextPage () {
        $('#confirmation').modal('hide');
        if (!validatePage(currentPage)) {
            $('#next').popover('show')
        }
        else {
            $('#next').popover('hide');
            moveToPage(currentPage + 1);
            if (mathbotProgressInterval) {
                clearInterval(mathbotProgressInterval)
            }
        }
    }

    function previousPage () {
        moveToPage(currentPage - 1)
    }

    function nextQuiz (response, section) {
        if (currentQuizPage > 0) {
            quizResponse[section].push(response);
            quizTimeStamp[section].push(new Date() * 1)
        }

        $('#next').hide();
        $('#prev').hide();

        currentQuizPage += 1;
        $('.quiz-' + section).hide();
        $('#quiz-' + section + '-' + currentQuizPage).show();

        if (currentQuizPage === QUIZLENGTH[section] + 1) {
            if (section === 0) {
                checkPrerequisite(function () {
                    $('#next').show();
                    $('#prev').show();
                    nextPage();
                    currentQuizPage = 0;
                })
            }
            else if (section === 1) {
                checkPreQuiz(function () {
                    $('#next').show();
                    $('#prev').show();
                    nextPage();
                    currentQuizPage = 0;
                })
            }
            else if (section === 2) {
                mySubmit()
            }
            else {
                $('#next').show();
                $('#prev').show();
                nextPage();
                currentQuizPage = 0;
            }
        }
    }

    function checkPrerequisite (callbackOnEligible) {
        getPartialForm();
        console.log('Checking prerequisite');
        console.log(partial_form_content);
        var flag = 0;
        if (// must get first question correct
        (partial_form_content['quiz-0-1-1'] !== '0.25' &&
            partial_form_content['quiz-0-1-1'] !== '.25' &&
            partial_form_content['quiz-0-1-1'] !== '1/4' &&
            partial_form_content['quiz-0-1-1'] !== '1 / 4') ||

        // must get second or third question correct
        (partial_form_content['quiz-0-2-1'] !== '-2' &&
            partial_form_content['quiz-0-3-1'] !== '-1') ||

        // cannot get fourth question completely correct
        (partial_form_content['quiz-0-4-1'] === '3' &&
            partial_form_content['quiz-0-4-2'] === '2') ||

        // cannot get fifth question completely correct
        (partial_form_content['quiz-0-5-1'] === '4' &&
            partial_form_content['quiz-0-5-2'] === '2')
        ) {
            flag = 1
        }

        if (flag) {
            console.log('Skip to submit.');
            // disable logging as leaving the page
            window.onbeforeunload = null;
            window.onunload = null;
            logPartialForm(
                'Ineligible',
                true,
                function () {
                    console.log('submit external!');
                    // when success, submit the mturk form
                    submitButtonClicked = true;
                    $('#completion-form').submit();
                    console.log('submitted external!')

                },
            )
        } else {
            callbackOnEligible()
        }

    }

    function checkPreQuiz (callbackOnEligible) {
        const answer = {
            'quiz-1-1-1': '64',
            'quiz-1-2-1': '-26',
            'quiz-1-3-1': '0',
            'quiz-1-3-2': '11',
            'quiz-1-4-1': '-17',
            'quiz-1-4-2': '9',
            'quiz-1-5-1': '29',
            'quiz-1-6-1': '-22',
            'quiz-1-7-1': '26',
            'quiz-1-8-1': '12-7(n-1)',
            'quiz-1-9-1': '-45+15(n-1)',
            'quiz-1-10': '3',
            'quiz-1-11': '1',
        };
        const threshold = 7;
        getPartialForm();
        var dummyAnswer = false;
        var rightAnswer = 0;
        var emptyAnswer = 0;
        for (var q in answer) {
            var correctAnswer = answer[q];
            var userAnswer = partial_form_content[q];
            //remove space
            userAnswer = userAnswer.replace('\s/g', '');
            //to lower cases
            userAnswer = userAnswer.toLowerCase();
            //replace `+-' with `-'
            userAnswer = userAnswer.replace('\+-', '');
            //remove `*'
            userAnswer = userAnswer.replace('\*', '');
            console.log(correctAnswer, userAnswer);

            if (correctAnswer === userAnswer) {
                rightAnswer += 1;
                if (q === 'quiz-1-7-1') {
                    dummyAnswer = true
                }
            }
            if (userAnswer === '') {
                emptyAnswer += 1
            }
        }

        // second condition - answer everything blank except dummy question
        if (rightAnswer > threshold || emptyAnswer === (Object.keys(answer).length - 1) || !dummyAnswer) {
            console.log('Skip to submit.');
            // disable logging as leaving the page
            window.onbeforeunload = null;
            window.onunload = null;
            logPartialForm(
                'Ineligible',
                true,
                function () {
                    console.log('submit external!');
                    // when success, submit the mturk form
                    submitButtonClicked = true;
                    $('#completion-form').submit();
                    console.log('submitted external!')

                }
            )
        } else {
            callbackOnEligible()
        }

    }

    /* Page event */
    window.onbeforeunload = function (e) {
        if (!submitButtonClicked) {
            return 'Warning: If you close this page, you cannot return to the experiment. Are you sure you want to exit?'
        }
    };

    window.onunload = function () {
        if (!submitButtonClicked) {
            // only submit partial form when leaving the page or submit button is clicked
            logPartialForm(currentPage,
                true,
                function () {
                    // only submit HITs for those who go beyond page 3
                    if (currentPage >= 3) {
                        console.log('submit external!');
                        // when success, submit the mturk form
                        submitButtonClicked = true;
                        $('#completion-form').submit();
                        console.log('submitted external!')
                    }
                },
            )
        }

        // explicitly unload iframe for the potential mathbot window to trigger conversation logging
        $('#expFrame').attr('src', 'about:blank')
    };

    function mySubmit () {
        if (!validatePage(currentPage)) {
            $('#submit').popover('show')
        } else {
            // only submit partial form when leaving the page or submit button is clicked
            logPartialForm(
                'Submitted',
                true,
                function () {
                    console.log('submit external!');
                    // when success, submit the mturk form
                    submitButtonClicked = true;
                    $('#completion-form').submit();
                    console.log('submitted external!')
                },
            )
        }
    }

    $(document).ready(function () {
        currentPage = 0;
        logPartialForm(false, false);
        moveToPage(currentPage + 1);
        $('.progress-bar').css('width', currentPage / MAXPAGE * 100 + '%');

        $('#next').popover({
            content: 'Please answer each question.',
            placement: 'right',
            trigger: 'focus',
        });

        $('#submit').popover({
            content: 'Before submitting, please answer each question.',
            placement: 'bottom',
            trigger: 'focus',
        })
        //DEBUG = 1;
        //$('.form-page').show();
    })

</script>
</body>

</html>
